services:
  # 1. Monolith (Web + Worker)
  - type: web
    name: stream-sentry
    env: python
    buildCommand: "uv sync && uv run manage.py collectstatic --noinput"
    startCommand: "./start.sh"
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: stream-sentry-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: stream-sentry-redis
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: stream-sentry-redis
          property: connectionString
      - key: SECRET_KEY
        generateValue: true
      - key: WEB_CONCURRENCY
        value: 2

databases:
  # 2. Postgres Service
  - name: stream-sentry-db
    databaseName: stream_sentry
    user: streamsentry
    plan: free # 90 Days trial

  # 3. Redis Service
  - name: stream-sentry-redis
    plan: free # Free tier Redis
